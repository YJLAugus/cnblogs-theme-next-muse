<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer"/>
    <title>Title</title>
    <script src="module/hljs.js"></script>
    <script src="module/vue.js"></script>
    <script src="module/http.js"></script>
    <script src="module/qs.js"></script>
    <script src="module/router.js"></script>
    <link rel="stylesheet" href="module/css/awesome.css">
    <link rel="stylesheet" href="module/css/solar-light.css">

</head>
<body>

<!--博客配置文件-->
<script>
    const blogConfig = {
        proxyHost: 'http://cnblogs.zeer.beer',

        title: 'Zeer x Beer',
        subtitle: '余自必, 犹必然',
        menus: [
            {icon: 'bell', name: 'Home', link: '//baidu.com'},
            {icon: 'book', name: 'Docs', link: ''},
        ],

        copyrightTime: '2020',
        copyright: 'ZeerBeer',
        customFooter: `Source code <a href="https://github.com/ZeerBeer/cnblogs-rebuild">here</a>`,

        clientId: '4e1ae68e-f4af-43d5-bb94-ed7f00babcb4',
        clientSecret: 'VNA775gWdBT-4hPytT_Sfp6rM4lAgJbhezYp5q0yN_4r8zPSJ5iFsRuMCNNVdnHUhay_nx5-8-jHEWUr',
        grantType: 'client_credentials',
    }
</script>

<!--头部-->
<template id="blog-header-tmp">
    <hearder id="blog-header">
        <div id="title">
            <div :style="styleInitL1">{{title}}</div>
        </div>
        <div id="subtitle" :style="styleInitL2">{{subtitle}}</div>
        <ul :style="styleInitL3">
            <li v-for="menu in menus" :key="menu.name" @click="href(menu.link)">
                <i class="fa fa-fw" :class="'fa-' + menu.icon"></i>
                {{menu.name}}
            </li>
        </ul>
    </hearder>
</template>

<script>
    const BlogHeader = {
        template: '#blog-header-tmp',
        data() {

            return {
                title: blogConfig.title,
                subtitle: blogConfig.subtitle,
                menus: blogConfig.menus,

                styleInitL1: {
                    top: '-1rem',
                    opacity: '0',
                },
                styleInitL2: {
                    top: '-1rem',
                    opacity: '0',
                },
                styleInitL3: {
                    top: '-1rem',
                    opacity: '0',
                },
            }
        },
        mounted() {
            this.level3Loding()
        },
        methods: {
            level3Loding() {
                setTimeout(res => {
                    this.styleInitL1.top = '0rem'
                    this.styleInitL1.opacity = '1'
                }, 10)
                setTimeout(res => {
                    this.styleInitL2.top = '0rem'
                    this.styleInitL2.opacity = '1'
                }, 500)
                setTimeout(res => {
                    this.styleInitL3.top = '0rem'
                    this.styleInitL3.opacity = '1'
                }, 1000)
            },
            href(url) {
                window.location.href = url
            }
        }

    }
</script>

<style>
    #blog-header {

        height: 16rem;

        display: flex;
        flex-direction: column;
        align-items: center;


    }

    #blog-header #title {
        margin-top: 6rem;

        padding-left: 2rem;
        padding-right: 2rem;

        background: #222;

        font-size: 1.375em;
        font-family: Lato, "PingFang SC", "Microsoft YaHei", sans-serif;
        font-weight: normal;
        color: #fff;


    }

    #blog-header #title div {

        position: relative;

        transition: all .5s ease-in-out;
    }


    #blog-header #subtitle {

        position: relative;

        color: #999;
        font-size: 0.8125em;
        margin: 10px 0;

        transition: all .5s ease-in-out;
    }

    #blog-header ul {

        display: flex;
        flex-direction: row;
        justify-content: center;

        list-style: none;

        padding: 1rem 0 0;

        margin: 0;

        color: #555;

        position: relative;


        transition: all .5s ease-in-out;
    }

    #blog-header ul li {
        display: flex;
        flex-direction: column;
        align-items: center;

        margin-left: .5rem;
        margin-right: .5rem;

        font-size: 0.8125em;
    }
</style>
<!--头部-->


<!--文章-->
<template id="blog-post-tmp">
    <div id="blog-post">
        <article v-for="item in listData">
            <header><h2 :style="styleInitL1"> {{item.title}} </h2></header>
            <div class="mate" :style="styleInitL2"><i class="fa fa-fw fa-calendar-o"></i> Posted on {{item.date}}</div>
            <div v-html="moreFilterData(item)" :style="styleInitL2"></div>
        </article>
    </div>
</template>

<script>
    const BlogPost = {
        template: '#blog-post-tmp',
        data() {
            return {
                styleInitL1: {
                    top: '-1rem',
                    opacity: '0',
                },
                styleInitL2: {
                    top: '-1rem',
                    opacity: '0',
                },
                listData: []

            }
        },
        props: [
            "cnblogsToken",
        ],

        async created() {

            // console.log(this.$route.params.num)

            if (!this.$route.params.num) {
                this.$route.params.num = 1
            }
            // console.log(this.cnblogsToken)

            this.updatePage(this.$route.params.num)

        }, beforeMount() {

        },
        beforeUpdate() {
            console.log(1)
            //

            this.f()
            // this.level2Loading()
        },
        updated() {

            console.log(2)
            this.level2Loading()
        },
        methods: {
            f() {
                this.styleInitL1.top = '-1rem'
                this.styleInitL1.opacity = '0'
                this.styleInitL1.top = '-1rem'
                this.styleInitL1.opacity = '0'
            },
            level2Loading() {


                setTimeout(res => {

                    this.styleInitL1.top = '0rem'
                    this.styleInitL1.opacity = '1'
                }, 10)
                setTimeout(res => {
                    this.styleInitL2.top = '0rem'
                    this.styleInitL2.opacity = '1'
                }, 500)
            },
            moreFilterData(item) {
                // console.log(500, item)

                return item.data.slice(0, item.data.indexOf("<!--more-->") === -1 ?
                    item.data.length : item.data.indexOf("<!--more-->"))

            },
            async updatePage(pageNum) {
                const list = await axios({
                    method: "GET",
                    url: blogConfig.proxyHost + `/api/blogs/zeerbeer/posts?pageIndex=` + pageNum,
                    data: {},
                    headers: {
                        'Authorization': 'Bearer ' + this.cnblogsToken
                    },
                })

                // console.log(list)

                const listData = list.data


                // console.log(listData)

                const tasks = []

                listData.forEach(e => {
                    // console.log(e)

                    const promise = axios({
                        method: "GET",
                        url: blogConfig.proxyHost + `/api/blogposts/` + e.Id + `/body`,
                        data: {},
                        headers: {
                            'Authorization': 'Bearer ' + this.cnblogsToken
                        },
                    })

                    tasks.push(promise)

                    promise.then(res => {
                        res.id = e.Id
                        res.title = e.Title
                        res.date = e.PostDate.slice(0, e.PostDate.indexOf("T"))
                        // console.log(res)
                        this.listData.push(res)
                        // console.log(1, this.listData)
                    })


                })

                await Promise.all(tasks).then(res => {
                    // console.log(res)
                    this.listData = res.sort((o1, o2) => {
                        return o1.date - o2.date
                    })

                    // console.log(this.listData)
                })

                document.querySelectorAll('pre code').forEach((block) => {

                    hljs.highlightBlock(block);
                })
            }
        },
        watch: {
            async $route(to, from) {


                this.updatePage(to.params.num)
                // document.documentElement.scrollTop = 0
                window.scrollTo({
                    top: 0,
                    behavior: "smooth"
                });
            }
        }
    }

    // 最大最小控制内边距
    // 一样负责外边距
</script>

<style>
    #blog-post article {
        max-width: 50rem;
        width: 100%;
        min-width: 50rem;

        display: flex;
        flex-direction: column;
        align-items: center;

        margin-right: 4rem;
        margin-left: 4rem;
    }

    #blog-post .mate {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;

        margin-top: .1rem;


        line-height: 2;
        font-size: 0.75em;
        color: #999;
    }

    #blog-post header h2 {
        color: #2c3e50;
        line-height: 1.25;
        font-weight: 600;
        font-size: 1.65rem;


        margin: 0;

        border-bottom: rgba(0, 0, 0, 0.0) solid .1rem;
        position: relative;
        transition: all .5s ease-in-out;
    }

    #blog-post header h2:hover {

        border-bottom: #555 solid .1rem;
        transition: all .5s ease-in-out;
    }

    #blog-post h3 {
        font-size: 1.35rem;
    }

    #blog-post blockquote {
        background-color: #eee;

        padding: 1.5rem;

        display: flex;
        margin-block-start: 0em;
        margin-block-end: 0em;
        margin-inline-start: 0px;
        margin-inline-end: 0px;
    }

    #blog-post img {
        width: 100%;
    }

    #blog-post div {
        width: 100%;


        position: relative;
        transition: all .5s ease-in-out;
    }


    #blog-post pre code {
        padding: 1rem;
    }

    #blog-post code {
        font-family: source-code-pro, Menlo, Monaco, Consolas, Courier New, monospace;
    }
</style>
<!--文章-->


<!--分页-->
<template id="blog-paginate-tmp">
    <nav id="blog-paginate">
        <span :style="styleInitL1">
            <i class="fa fa-angle-left"></i>
        </span>

        <span v-for="pageNum in pageNums" :style="styleInitL1"
              :class="curPageNum == pageNum?'current':''"
              @click="$router.push({ path: '/page/' + pageNum })">{{pageNum}}</span>

        <span :style="styleInitL1">
            <i class="fa fa-angle-right"></i>
        </span>
    </nav>
</template>

<script>
    const BlogPaginate = {
        template: '#blog-paginate-tmp',
        props: [
            "cnblogsToken"
        ],
        data() {
            return {
                pageNums: 0,
                curPageNum: 0,
                styleInitL1: {
                    top: '1rem',
                    opacity: '0',
                },
            }
        },

        async created() {

            // console.log(this.$route.params.num)

            this.curPageNum = this.$route.params.num

            if (!this.$route.params.num) {
                this.$route.params.num = 1
            }

            axios({
                method: "GET",
                url: blogConfig.proxyHost + `/api/blogs/zeerbeer`,
                data: {},
                headers: {
                    'Authorization': 'Bearer ' + this.cnblogsToken
                },
            }).then(res => {

                // console.log(res)

                this.pageSize = res.data.pageSize
                this.postCount = res.data.postCount

                this.pageNums = Math.ceil(res.data.postCount / res.data.pageSize)

            })

        },
        async updated() {

            // console.log(1)

            setTimeout(res => {
                this.styleInitL1.top = '0rem'
                this.styleInitL1.opacity = '1'
            }, 10)
        },

        watch: {
            async $route(to, from) {
                if (to.name === 'page')
                    this.curPageNum = this.$route.params.num
            }
        }
    }
</script>

<style>
    #blog-paginate {
        display: flex;
        justify-content: center;

        max-width: 50rem;
        width: 100%;
        min-width: 50rem;

        border-top: #eee solid .1rem;


    }

    #blog-paginate span {

        border-top: 1px solid rgba(0, 0, 0, 0.0);
        transition: all .5s ease-in-out;

        padding: .5rem;

        position: relative;


    }


    #blog-paginate span:hover {
        border-top: 1px solid #555;

    }

    #blog-paginate .current {
        background: #ccc;
    }
</style>
<!--分页-->


<!--底部-->
<template id="blog-footer-tmp">
    <div id="blog-footer" :style="styleInitL1">


        <div class="copyright">

            © 2020 –<span itemprop="copyrightYear">{{copyrightTime}}</span><span class="with-love"><i
                class="fa fa-heart"></i></span>
            <span class="author" itemprop="copyrightHolder">{{copyright}}</span>

        </div>

        <div class="footer-custom" v-html="blogConfig.customFooter">

        </div>


    </div>
</template>

<script>
    const BlogFooter = {
        template: '#blog-footer-tmp',

        data() {
            return {
                copyrightTime: blogConfig.copyrightTime,
                copyright: blogConfig.copyright,
                styleInitL1: {
                    top: '1rem',
                    opacity: '0',
                },
            }
        },

        mounted() {


            setTimeout(res => {
                this.styleInitL1.top = '0rem'
                this.styleInitL1.opacity = '1'
            }, 1000)
        }


    }
</script>

<style>
    #blog-footer {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 3rem;

        color: #999;
        font-size: 0.875em;

        transition: all .5s ease-in-out;

        position: relative;
    }

    #blog-footer .copyright {
        margin: .5rem 0;
    }

    .with-love {
        display: inline-block;
        animation: heartbeat 1.33s ease-in-out infinite;
        margin: 0 .5rem;
    }

    @keyframes heartbeat {
        0%, 100% {
            transform: scale(1);
        }
        10%, 30% {
            transform: scale(0.9);
        }
        20%, 40%, 60%, 80% {
            transform: scale(1.1);
        }
        50%, 70% {
            transform: scale(1.1);
        }
    }

</style>
<!--底部-->


<!--全局-->
<div id="app">
    <blog-header></blog-header>

    <router-view v-if="cnblogsToken != ''" :cnblogs-token="cnblogsToken"></router-view>
    <!--    <blog-post v-for="item in listData" :item="item"></blog-post>-->

    <blog-paginate v-if="cnblogsToken != ''" :cnblogs-token="cnblogsToken"></blog-paginate>

    <blog-footer></blog-footer>
</div>

<script>


    new Vue({
        router: new VueRouter({
            routes: [
                {path: '/page/:num', name: 'page', component: BlogPost},
                {path: '/', component: BlogPost}
            ]
        }),
        data: {
            cnblogsToken: '',
            listData: [],
            pageSize: 0,
            postCount: 0,
            pageNums: 5,
            curPageNum: 1,
        },
        components: {
            BlogHeader: BlogHeader,
            BlogPost: BlogPost,
            BlogPaginate: BlogPaginate,
            BlogFooter: BlogFooter,
        },
        async created() {

            // console.log('created')

            if ((!localStorage.cnblogsToken || !localStorage.cnblogsTokenExpires)
                || Date.parse(new Date()) / 1000 > localStorage.cnblogsTokenExpires) {


                const res = await axios({
                    method: "POST",
                    url: blogConfig.proxyHost + `/token`,
                    data: Qs.stringify({
                        client_id: blogConfig.clientId,
                        client_secret: blogConfig.clientSecret,
                        grant_type: blogConfig.grantType,
                    }),
                    headers: {
                        'content-type': "application/x-www-form-urlencoded;"
                    }
                })

                // let curTime = Date.parse(new Date()) / 1000 - localStorage.cnblogsTokenExpires
                // console.log(Date.parse(new Date()) / 1000)
                // console.log(localStorage.cnblogsTokenExpires)
                // console.log(curTime)
                // console.log(res)
                // console.log(cnblogsToken)

                localStorage.cnblogsTokenExpires = Date.parse(new Date()) / 1000 + res.data.expires_in
                localStorage.cnblogsToken = res.data.access_token
                // console.log(Date.parse(new Date()) / 1000)
                // console.log(localStorage.cnblogsTokenExpires)
                // console.log(localStorage.cnblogsToken)

            }

            this.cnblogsToken = localStorage.cnblogsToken

            //
            // axios({
            //     method: "GET",
            //     url: blogConfig.proxyHost + `/api/blogs/zeerbeer`,
            //     data: {},
            //     headers: {
            //         'Authorization': 'Bearer ' + localStorage.cnblogsToken
            //     },
            // }).then(res => {
            //
            //     // console.log(res)
            //
            //     this.pageSize = res.data.pageSize
            //     this.postCount = res.data.postCount
            //
            //     this.pageNums = Math.ceil(res.data.postCount / res.data.pageSize)
            //
            //     // console.log(this.pageNums)
            // })

        },
        async mounted() {


            console.log('mounted')


        },
    }).$mount('#app')

</script>

<style>
    body {
        margin: 0;
        padding: 0;

    }

    #app {
        display: flex;
        flex-direction: column;
        align-items: center;

        color: #2c3e50;

    }

    #app h1, h2, h3, h4, h5 {
        font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen, Ubuntu, Cantarell, Fira Sans, Droid Sans, Helvetica Neue, sans-serif;

        font-weight: 600;
        line-height: 1.25;

    }


    #app p {
        display: flex;
        margin-block-start: 0em;
        margin-block-end: 0em;
        margin-inline-start: 0em;
        margin-inline-end: 0em;

        font-size: 1rem;

        line-height: 1.7;
    }

    ::-webkit-scrollbar { /*滚动条整体样式*/

        width: 10px; /*高宽分别对应横竖滚动条的尺寸*/

        height: 5px;

    }

    ::-webkit-scrollbar-thumb { /*滚动条里面小方块*/

        border-radius: 10px;

        -webkit-box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);

        background: #535353;

    }

    ::-webkit-scrollbar-track { /*滚动条里面轨道*/

        -webkit-box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);

        border-radius: 10px;

        background: #EDEDED;

    }
</style>
<!--全局-->


</body>
</html>